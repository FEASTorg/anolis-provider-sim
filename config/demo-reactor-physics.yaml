# Physics Configuration: Multi-Zone Reactor
# Models reactor core and cooling jacket with bidirectional heat transfer
# Demonstrates complex signal routing and thermal coupling

physics:
  models:
    - id: core_thermal
      type: thermal_mass
      params:
        thermal_mass: 12000.0           # J/K - large thermal mass (reaction mixture)
        heat_transfer_coeff: 35.0       # W/K - good convection to jacket
        initial_temp: 80.0              # C - exothermic reaction temperature
    
    - id: jacket_thermal
      type: thermal_mass
      params:
        thermal_mass: 4000.0            # J/K - smaller mass (cooling water)
        heat_transfer_coeff: 25.0       # W/K - heat exchange with core
        initial_temp: 40.0              # C - supply water temperature

  signal_graph:
    # Core heating (exothermic reaction + control heaters)
    - source: reactor_core/relay1_state
      target: core_thermal/heating_power
      transform:
        type: linear
        scale: 1200.0       # High-power heater for startup
        offset: 0.0
    
    - source: reactor_core/relay2_state
      target: core_thermal/heating_power
      transform:
        type: linear
        scale: 1200.0       # Secondary heater
        offset: 0.0
    
    # Jacket cooling (controlled by jacket relays)
    - source: reactor_jacket/relay1_state
      target: jacket_thermal/heating_power
      transform:
        type: linear
        scale: -800.0       # Negative = cooling effect (chiller)
        offset: 0.0
    
    # Heat transfer from core to jacket (temperature difference drives flow)
    # NOTE: This is simplified - real coupling would need custom transform
    - source: core_thermal/temperature
      target: jacket_thermal/heating_power
      transform:
        type: linear
        scale: 15.0         # Heat flow coefficient (W/K of temp difference)
        offset: -1200.0     # Offset to create temp-dependent coupling
    
    # Pump speed affects cooling efficiency (faster = better heat removal)
    - source: coolant_pump/speed
      target: jacket_thermal/heating_power
      transform:
        type: linear
        scale: -0.15        # Higher RPM = more cooling (-0.15 W per RPM)
        offset: 0.0
    
    # Core temperature sensors (different locations, different lags)
    - source: core_thermal/temperature
      target: reactor_core/tc1_temp
      transform:
        type: first_order_lag
        tau_s: 4.5          # TC1: center of reactor (slow response)
    
    - source: core_thermal/temperature
      target: reactor_core/tc2_temp
      transform:
        type: first_order_lag
        tau_s: 2.2          # TC2: near wall (faster response)
    
    # Jacket temperature sensors
    - source: jacket_thermal/temperature
      target: reactor_jacket/tc1_temp
      transform:
        type: first_order_lag
        tau_s: 1.5          # TC1: inlet measurement
    
    - source: jacket_thermal/temperature
      target: reactor_jacket/tc2_temp
      transform:
        type: first_order_lag
        tau_s: 1.8          # TC2: outlet measurement
    
    # Add realistic measurement noise to all sensors
    - source: reactor_core/tc2_temp
      target: reactor_core/tc2_temp
      transform:
        type: noise
        amplitude: 0.4      # ±0.4°C noise
        seed: 101
    
    - source: reactor_jacket/tc1_temp
      target: reactor_jacket/tc1_temp
      transform:
        type: noise
        amplitude: 0.25     # ±0.25°C noise
        seed: 202

  rules:
    # Emergency shutdown: Disable core heaters if temperature exceeds safe limit
    - id: core_emergency_shutdown
      condition: "core_thermal/temperature > 280.0"
      on_error: log_and_continue
      actions:
        - device: reactor_core
          function: set_relay
          args:
            relay_id: 1
            enabled: false
        - device: reactor_core
          function: set_relay
          args:
            relay_id: 2
            enabled: false
    
    # Auto-cooling: Enable chiller if core temperature high
    - id: auto_cooling_enable
      condition: "core_thermal/temperature > 150.0"
      on_error: log_and_continue
      actions:
        - device: reactor_jacket
          function: set_relay
          args:
            relay_id: 1
            enabled: true
    
    # Speed up pump if jacket temperature rises
    - id: pump_speed_boost
      condition: "jacket_thermal/temperature > 60.0"
      on_error: log_and_continue
      actions:
        - device: coolant_pump
          function: set_speed
          args:
            rpm: 4000.0
